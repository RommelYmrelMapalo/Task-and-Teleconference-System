{% extends "base.html" %}
{% block title %}Task Dashboard{% endblock %}

{% block content %}

<style>
  /* only the task list scrolls */
  .scroll{
    flex:1;
    overflow-y:auto;
    padding-right:8px;
  }

  /* =========================
     Task focus highlight
     ========================= */
  .task-item.task-focus {
    outline: 3px solid rgba(99, 102, 241, 0.55);
    box-shadow: 0 0 0 6px rgba(99, 102, 241, 0.12);
    border-radius: 14px;
    animation: taskPulse 1.2s ease-in-out 0s 2;
  }
  @keyframes taskPulse {
    0%   { transform: scale(1); }
    40%  { transform: scale(1.01); }
    100% { transform: scale(1); }
  }

  /* clickable titles */
  .task-title-link{
    display:inline-block;
    margin:0;
    font-weight:900;
    color:inherit;
    text-decoration:none;
    cursor:pointer;
  }
  .task-title-link:hover{ text-decoration: underline; }

  /* icon-style button */
  .btn-icon{
    width:34px;
    height:34px;
    border-radius:10px;
    border:1px solid rgba(15,23,42,.12);
    background:#fff;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    padding:0;
    line-height:1;
  }
  .btn-icon.ghost{ background:transparent; }
  .task-check-btn{ cursor:pointer; }
  .task-check-btn.is-done{ background:#10b981; border-color:#10b981; }
  .st-pending{ background:#fef3c7; border-color:#f7c900; color:#92400e; }
  .st-delayed{ background:#fef2f2; border-color:#fa0000; color:#b91c1c; }
  .st-completed{ background:#ecfdf5; border-color:#00ff59; color:#065f46; }
</style>

<div class="main-inner">

  <h1 class="td-title">Dashboard &nbsp;›&nbsp; Tasks</h1>
  <div class="td-sub">Manage and track your assigned tasks</div>

  {% if request.endpoint == "views.task_dashboard" %}
    {% if request.args.get("updated") in ["1", "true"] %}
      <div class="modal-overlay show autoModal">
        <div class="modal-popup success modern-popup" role="status" aria-live="polite">
          <div class="modal-icon-wrap">
            <div class="modal-icon" aria-hidden="true">✓</div>
          </div>
          <div class="modal-text">Task updated!</div>
          <div class="modal-subtext">Your latest task changes were saved successfully.</div>
          <div class="modal-progress" aria-hidden="true"></div>
        </div>
      </div>
    {% endif %}

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% set rendered = namespace(items=[]) %}
        {% for category, message in messages %}
          {% if message != "Task updated!" %}
            {% set key = category ~ "::" ~ message %}
            {% if key not in rendered.items %}
              {% set rendered.items = rendered.items + [key] %}
              <div class="modal-overlay show autoModal">
                <div class="modal-popup {{ category }} modern-popup" role="status" aria-live="polite">
                  <div class="modal-icon-wrap">
                    <div class="modal-icon" aria-hidden="true">
                      {% if category == "error" %}✕{% else %}✓{% endif %}
                    </div>
                  </div>
                  <div class="modal-text">{{ message }}</div>
                  <div class="modal-subtext">
                    {% if category == "error" %}
                      Please review your changes and try again.
                    {% else %}
                      Your latest task changes were saved successfully.
                    {% endif %}
                  </div>
                  <div class="modal-progress" aria-hidden="true"></div>
                </div>
              </div>
            {% endif %}
          {% endif %}
        {% endfor %}
      {% endif %}
    {% endwith %}
  {% endif %}

  {# ===== counts based on tasks list ===== #}
  {% set all_count = tasks|length if tasks else 0 %}

  {% set revision_tasks = tasks|selectattr("status","equalto","for_revision")|list if tasks else [] %}
  {% set revision_count = revision_tasks|length %}

  {% set completed_tasks = tasks|selectattr("status","equalto","completed")|list if tasks else [] %}
  {% set completed_count = completed_tasks|length %}

  {% set delayed_tasks = tasks|rejectattr("status","equalto","completed")
                              |selectattr("deadline")
                              |selectattr("deadline","lt",now_dt)
                              |list if tasks else [] %}
  {% set delayed_count = delayed_tasks|length %}

  {% set active_tasks = tasks|rejectattr("status","equalto","completed")
                            |rejectattr("status","equalto","for_revision")
                            |list if tasks else [] %}
  {% set active_count = active_tasks|length %}

  <div class="td-pills">
    <button class="pill-tab active" type="button" data-filter="all">
      All Tasks <span class="pill-count">{{ all_count }}</span>
    </button>

    <button class="pill-tab" type="button" data-filter="active">
      Active <span class="pill-count">{{ active_count }}</span>
    </button>

    <button class="pill-tab" type="button" data-filter="revision">
      For Revision <span class="pill-count">{{ revision_count }}</span>
    </button>

    <button class="pill-tab" type="button" data-filter="completed">
      Completed <span class="pill-count">{{ completed_count }}</span>
    </button>

    <button class="pill-tab" type="button" data-filter="delayed">
      Delayed <span class="pill-count">{{ delayed_count }}</span>
    </button>
  </div>

  <div class="td-toolbar">
    <input id="taskSearch" class="form-control td-search" placeholder="Search tasks..." />
    <select id="priorityFilter" class="form-control td-filter" style="width:160px;">
      <option value="all">All Priority</option>
      <option value="high">High</option>
      <option value="normal">Normal</option>
      <option value="low">Low</option>
    </select>
  </div>

  <div class="scroll">

    <!-- ===== Active Tasks ===== -->
    <div class="sec open" data-section="active">
      <button class="sec-h" type="button">
        <div class="sec-h-left">
          <span class="sec-title">Active Tasks</span>
          <span class="sec-badge badge-active"></span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="sec-count">{{ active_count }}</span>
          <span class="sec-caret">▾</span>
        </div>
      </button>

      <div class="sec-body">
        {% if active_tasks and active_tasks|length > 0 %}
          {% for task in active_tasks %}
            {% set is_delayed = task.status != 'completed' and task.deadline and task.deadline < now_dt %}
            <div class="task-row task-item"
                 id="task-{{ task.id }}"
                 data-task-id="{{ task.id }}"
                 data-status="{{ task.status }}"
                 data-original-status="{{ task.status }}"
                 data-title="{{ (task.title ~ ' ' ~ (task.description or ''))|lower }}"
                 data-priority="{{ (task.priority or 'normal')|lower if task.priority is defined else 'normal' }}"
                 data-deadline="{{ task.deadline.strftime('%Y-%m-%dT%H:%M:%S') if task.deadline else '' }}">

              <div class="task-left">
                <button type="button"
                        class="task-check task-check-btn"
                        aria-label="Toggle complete"
                        data-complete-task="{{ task.id }}"></button>

                <div class="task-info">
                  <a class="task-title-link"
                     href="{{ url_for('views.task_dashboard') }}?focus={{ task.id }}"
                     data-focus-task="{{ task.id }}">
                    {{ task.title }}
                  </a>

                  <div class="task-meta">
                    {{ task.description }}
                  </div>
                </div>

                <div class="task-tags">
                  <span class="status {{ 'st-delayed' if is_delayed else 'st-pending' }}" data-status-pill>{{ 'DELAYED' if is_delayed else task.status|replace("_"," ")|upper }}</span>
                  {% set pr = (task.priority or 'normal')|lower %}
                  <span class="prio prio-{{ pr }}">{{ pr|upper }}</span>
                </div>
              </div>

              <div class="task-right">
                <div class="task-actions">
                  <button type="button" class="btn-mini" data-open-task="{{ task.id }}">Open</button>
                  <button type="button" class="btn-mini ghost" data-edit-task="{{ task.id }}">Edit</button>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding:12px 14px; color:#6b7280;" data-empty-state="active">No active tasks.</div>
        {% endif %}
      </div>
    </div>

    <!-- ===== For Revision Tasks ===== -->
    <div class="sec open" data-section="revision">
      <button class="sec-h" type="button">
        <div class="sec-h-left">
          <span class="sec-title">For Revision</span>
          <span class="sec-badge" style="background:#6366f1;"></span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="sec-count">{{ revision_count }}</span>
          <span class="sec-caret">▾</span>
        </div>
      </button>

      <div class="sec-body">
        {% if revision_tasks and revision_tasks|length > 0 %}
          {% for task in revision_tasks %}
            {% set is_delayed = task.status != 'completed' and task.deadline and task.deadline < now_dt %}
            <div class="task-row task-item"
                 id="task-{{ task.id }}"
                 data-task-id="{{ task.id }}"
                 data-status="{{ task.status }}"
                 data-original-status="{{ task.status }}"
                 data-title="{{ (task.title ~ ' ' ~ (task.description or ''))|lower }}"
                 data-priority="{{ (task.priority or 'normal')|lower }}"
                 data-deadline="{{ task.deadline.strftime('%Y-%m-%dT%H:%M:%S') if task.deadline else '' }}">

              <div class="task-left">
                <button type="button"
                        class="task-check task-check-btn"
                        aria-label="Toggle complete"
                        data-complete-task="{{ task.id }}"></button>

                <div class="task-info">
                  <a class="task-title-link"
                     href="{{ url_for('views.task_dashboard') }}?focus={{ task.id }}"
                     data-focus-task="{{ task.id }}">
                    {{ task.title }}
                  </a>
                  <div class="task-meta">{{ task.description }}</div>
                </div>

                <div class="task-tags">
                  <span class="status {{ 'st-delayed' if is_delayed else 'st-pending' }}" data-status-pill>{{ 'DELAYED' if is_delayed else task.status|replace("_"," ")|upper }}</span>
                  {% set pr = (task.priority or 'normal')|lower %}
                  <span class="prio prio-{{ pr }}">{{ pr|upper }}</span>
                </div>
              </div>

              <div class="task-right">
                <div class="task-actions">
                  <button type="button" class="btn-mini" data-open-task="{{ task.id }}">Open</button>
                  <button type="button" class="btn-mini ghost" data-edit-task="{{ task.id }}">Edit</button>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding:12px 14px; color:#6b7280;" data-empty-state="revision">No tasks for revision.</div>
        {% endif %}
      </div>
    </div>

    <!-- ===== Completed Tasks ===== -->
    <div class="sec open" data-section="completed">
      <button class="sec-h" type="button">
        <div class="sec-h-left">
          <span class="sec-title">Completed Tasks</span>
          <span class="sec-badge badge-done"></span>
        </div>
        <div style="display:flex; align-items:center; gap:10px;">
          <span class="sec-count">{{ completed_count }}</span>
          <span class="sec-caret">▾</span>
        </div>
      </button>

      <div class="sec-body">
        {% if completed_tasks and completed_tasks|length > 0 %}
          {% for task in completed_tasks %}
            <div class="task-row task-item"
                 id="task-{{ task.id }}"
                 data-task-id="{{ task.id }}"
                 data-status="{{ task.status }}"
                 data-original-status="{{ task.status if task.status != 'completed' else 'in_progress' }}"
                 data-title="{{ (task.title ~ ' ' ~ (task.description or ''))|lower }}"
                 data-priority="{{ (task.priority or 'normal')|lower }}"
                 data-deadline="{{ task.deadline.strftime('%Y-%m-%dT%H:%M:%S') if task.deadline else '' }}">

              <div class="task-left">
                <button type="button"
                        class="task-check task-check-btn is-done"
                        aria-label="Toggle complete"
                        data-complete-task="{{ task.id }}"></button>

                <div class="task-info">
                  <a class="task-title-link"
                     href="{{ url_for('views.task_dashboard') }}?focus={{ task.id }}"
                     data-focus-task="{{ task.id }}">
                    {{ task.title }}
                  </a>
                  <div class="task-meta">{{ task.description }}</div>
                </div>

                <div class="task-tags">
                  <span class="status st-completed" data-status-pill>{{ task.status|replace("_"," ")|upper }}</span>
                  {% set pr = (task.priority or 'normal')|lower %}
                  <span class="prio prio-{{ pr }}">{{ pr|upper }}</span>
                </div>
              </div>

              <div class="task-right">
                <div class="task-actions">
                  <button type="button" class="btn-mini" data-open-task="{{ task.id }}">Open</button>
                  <button type="button" class="btn-mini ghost" data-edit-task="{{ task.id }}">Edit</button>
                </div>
              </div>
            </div>
          {% endfor %}
        {% else %}
          <div style="padding:12px 14px; color:#6b7280;" data-empty-state="completed">No completed tasks yet.</div>
        {% endif %}
      </div>
    </div>

    <br><br>
  </div>
</div>

<!-- =========================
     FILTER + ACCORDION JS
========================== -->
<script>
  // Accordion open/close
  document.querySelectorAll(".sec").forEach((sec) => {
    const header = sec.querySelector(".sec-h");
    header.addEventListener("click", () => {
      sec.classList.toggle("open");
    });
  });

  // Pills filter
  const pills = document.querySelectorAll(".pill-tab");
  const items = document.querySelectorAll(".task-item");
  const search = document.getElementById("taskSearch");
  const priority = document.getElementById("priorityFilter");

  // IMPORTANT: put these on window so other scripts can call them if needed
  window.activeFilter = "all";

  window.applyFilter = function applyFilter(){
    const q = (search.value || "").trim().toLowerCase();
    const p = priority.value;

    items.forEach((el) => {
      const title = el.dataset.title || "";
      const status = el.dataset.status || "";
      const pr = el.dataset.priority || "normal";

      const okSearch = !q || title.includes(q);
      const okPriority = (p === "all") || (pr === p);

      let okTab = true;

      if(window.activeFilter === "active"){
        okTab = (status !== "completed" && status !== "for_revision");
      }
      if(window.activeFilter === "revision"){
        okTab = (status === "for_revision");
      }
      if(window.activeFilter === "completed"){
        okTab = (status === "completed");
      }
      if(window.activeFilter === "delayed"){
        const deadline = parseDeadline(el.dataset.deadline || "");
        okTab = (status !== "completed" && !!deadline && deadline.getTime() < Date.now());
      }

      el.style.display = (okSearch && okPriority && okTab) ? "" : "none";
    });
  }

  pills.forEach((btn) => {
    btn.addEventListener("click", () => {
      pills.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      window.activeFilter = btn.dataset.filter;
      window.applyFilter();
    });
  });

  search.addEventListener("input", window.applyFilter);
  priority.addEventListener("change", window.applyFilter);

  function parseDeadline(raw){
    if(!raw) return null;
    const d = new Date(raw);
    return isNaN(d.getTime()) ? null : d;
  }

  function setStatusPill(taskId, status, fallback){
    const deadline = parseDeadline(document.querySelector(`[data-task-id="${taskId}"]`)?.dataset.deadline || "");
    const isDelayed = status !== "completed" && deadline && deadline.getTime() < Date.now();
    const text = status === "completed" ? "COMPLETED" : (isDelayed ? "DELAYED" : status.replaceAll("_", " ").toUpperCase());
    const css = status === "completed" ? "st-completed" : (isDelayed ? "st-delayed" : "st-pending");

    document.querySelectorAll(`#task-${taskId} [data-status-pill]`).forEach((pill)=>{
      pill.textContent = text;
      pill.classList.remove("st-pending","st-delayed","st-completed");
      pill.classList.add(css);
    });

    document.querySelectorAll(`#task-${taskId}`).forEach((row)=>{
      row.dataset.status = status;
      if(fallback && row.dataset.originalStatus === "completed"){
        row.dataset.originalStatus = fallback;
      }
     });
  }

  function sectionKeyForStatus(status){
    if(status === "completed") return "completed";
    if(status === "for_revision") return "revision";
    return "active";
  }

  function recalcCounts(){
    const active = document.querySelectorAll('[data-section="active"] .task-item').length;
    const revision = document.querySelectorAll('[data-section="revision"] .task-item').length;
    const completed = document.querySelectorAll('[data-section="completed"] .task-item').length;
    const all = active + revision + completed;

    const sectionCounts = { active, revision, completed };
    document.querySelectorAll('.sec').forEach((sec) => {
      const key = sec.dataset.section;
      const countNode = sec.querySelector('.sec-count');
      if(countNode && key in sectionCounts){
        countNode.textContent = sectionCounts[key];
      }
    });

    const pillCounts = { all, active, revision, completed };
    pills.forEach((pill) => {
      const key = pill.dataset.filter;
      const countNode = pill.querySelector('.pill-count');
      if(countNode && key in pillCounts){
        countNode.textContent = pillCounts[key];
      }
    });

    ["active", "revision", "completed"].forEach((section) => {
      const body = document.querySelector(`[data-section="${section}"] .sec-body`);
      const empty = document.querySelector(`[data-empty-state="${section}"]`);
      if(!body || !empty) return;
      const hasRows = body.querySelectorAll('.task-item').length > 0;
      empty.style.display = hasRows ? "none" : "";
    });
  }

  function moveTaskToSection(taskId, status){
    const row = document.querySelector(`#task-${taskId}`);
    if(!row) return;

    const section = sectionKeyForStatus(status);
    const targetBody = document.querySelector(`[data-section="${section}"] .sec-body`);
    if(!targetBody) return;

    targetBody.appendChild(row);
    recalcCounts();
  }

  document.addEventListener("click", async (e) => {
    const btn = e.target.closest("[data-complete-task]");
    if(!btn) return;

    const id = btn.getAttribute("data-complete-task");
    const row = document.querySelector(`#task-${id}`);
    if(!id || !row) return;

    const currentStatus = row.dataset.status || "in_progress";
    const originalStatus = row.dataset.originalStatus || (currentStatus === "completed" ? "in_progress" : currentStatus);
    const targetStatus = currentStatus === "completed" ? originalStatus : "completed";

    try{
      const body = new URLSearchParams({
        target_status: targetStatus,
        fallback_status: originalStatus,
      });
      const res = await fetch(`/task/${id}/complete`, {
        method: "POST",
        headers: { "X-Requested-With": "fetch", "Content-Type": "application/x-www-form-urlencoded" },
        body,
      });

      const data = await res.json();
      if(!res.ok || !data.ok) return;

      const done = data.status === "completed";
      document.querySelectorAll(`[data-complete-task="${id}"]`).forEach((check)=>{
        check.classList.toggle("is-done", done);
      });

      setStatusPill(id, data.status, originalStatus);
      moveTaskToSection(id, data.status);
      window.applyFilter();
    }catch(err){
      console.error(err);
    }
  });

  recalcCounts();
</script>

<!-- =========================================
     FLOATING ADD TASK + CREATE TASK DRAWER
========================================= -->

<button type="button" class="fab-task" id="openTaskDrawer" aria-label="Create task">
  <span class="fab-plus">+</span>
</button>

<div class="drawer-backdrop" id="drawerBackdrop"></div>

<aside class="task-drawer" id="taskDrawer" aria-hidden="true">
  <div class="drawer-head">
    <div>
      <div class="drawer-title">New Task</div>
      <div class="drawer-sub">Create and publish a task</div>
    </div>
    <button type="button" class="drawer-x" id="closeTaskDrawer" aria-label="Close">×</button>
  </div>

  <form method="POST" action="{{ url_for('views.create_task') }}" class="drawer-body" enctype="multipart/form-data">
    <div class="drawer-field">
      <div class="drawer-label">TITLE</div>
      <input name="title" class="drawer-input" placeholder="Task title..." required>
    </div>

    <div class="drawer-grid3">
      <div class="drawer-field">
        <div class="drawer-label">STATUS</div>
        <select name="status" class="drawer-input">
          <option value="in_progress" selected>In Progress</option>
          <option value="for_revision">For Revision</option>
          <option value="completed">Completed</option>
        </select>
      </div>

      <div class="drawer-field">
        <div class="drawer-label">TYPE</div>
        <select name="type" class="drawer-input">
          <option value="operational">Operational</option>
          <option value="meeting">Meeting</option>
          <option value="documentation">Documentation</option>
        </select>
      </div>

      <div class="drawer-field">
        <div class="drawer-label">PRIORITY</div>
        <select name="priority" class="drawer-input">
          <option value="low">Low</option>
          <option value="normal" selected>Normal</option>
          <option value="high">High</option>
        </select>
      </div>
    </div>

    <div class="drawer-grid3">
      <div class="drawer-field">
        <div class="drawer-label">DUE DATE</div>
        <input type="date" name="due_date" class="drawer-input" required>
      </div>

      <div class="drawer-field">
        <div class="drawer-label">DUE TIME</div>
        <input type="time" name="due_time" class="drawer-input">
      </div>

      <div class="drawer-field">
        <div class="drawer-label">EST. TIME</div>
        <input name="est_time" class="drawer-input" placeholder="30 min">
      </div>
    </div>

    <div class="drawer-field">
      <div class="drawer-label">ASSIGNEES</div>
      <div class="assignee-pill">
        <span class="assignee-dot"></span>
        <span>Assigned to you</span>
      </div>
      <small class="drawer-hint">For now, tasks are assigned to the logged-in user.</small>
      <small class="drawer-hint">Everyone can see and edit tasks.</small>
    </div>

    <div class="drawer-card">
      <div style="font-weight:900; margin-bottom:6px;">Attach Documents</div>
      <div class="drawer-muted" style="font-size:12px; margin-bottom:10px;">
        Upload a file to include with this task (PDF, DOCX, PNG, JPG).
      </div>
      <input type="file" name="file" class="drawer-file" />
    </div>

    <div class="drawer-field">
      <div class="drawer-label">DESCRIPTION</div>
      <textarea name="description" class="drawer-textarea" rows="5"
        placeholder="Write details..."></textarea>
    </div>

    <div class="drawer-footer">
      <button type="button" class="btn btn-light" id="cancelTaskDrawer">Cancel</button>
      <button type="submit" class="btn btn-primary">Publish</button>
    </div>
  </form>
</aside>

<script>
  (function () {
    const fab = document.getElementById("openTaskDrawer");
    const closeBtn = document.getElementById("closeTaskDrawer");
    const cancelBtn = document.getElementById("cancelTaskDrawer");
    const drawer = document.getElementById("taskDrawer");
    const backdrop = document.getElementById("drawerBackdrop");

    function openDrawer(){
      drawer.classList.add("open");
      backdrop.classList.add("open");
      drawer.setAttribute("aria-hidden", "false");
      document.body.classList.add("drawer-open");
      if(fab) fab.classList.add("fab-hidden");
    }

    function closeDrawer(){
      drawer.classList.remove("open");
      backdrop.classList.remove("open");
      drawer.setAttribute("aria-hidden", "true");
      document.body.classList.remove("drawer-open");
      if(fab) fab.classList.remove("fab-hidden");
    }

    if(fab) fab.addEventListener("click", openDrawer);
    if(closeBtn) closeBtn.addEventListener("click", closeDrawer);
    if(cancelBtn) cancelBtn.addEventListener("click", closeDrawer);
    if(backdrop) backdrop.addEventListener("click", closeDrawer);

    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape") closeDrawer();
    });
  })();
</script>

<!-- =========================================
     VIEW TASK DRAWER
========================================= -->
<div class="drawer-backdrop" id="viewBackdrop"></div>

<aside class="task-drawer" id="viewDrawer" aria-hidden="true">
  <div class="drawer-head">
    <div>
      <div class="drawer-title" id="viewTitle">Task</div>
      <div class="drawer-sub" id="viewSub">Details</div>
    </div>
    <button type="button" class="drawer-x" id="closeView" aria-label="Close">×</button>
  </div>

  <div class="drawer-body">
    <div class="drawer-kv"><div class="k">Status</div><div class="v" id="viewStatus">-</div></div>
    <div class="drawer-kv"><div class="k">Priority</div><div class="v" id="viewPriority">-</div></div>
    <div class="drawer-kv"><div class="k">Deadline</div><div class="v" id="viewDeadline">-</div></div>

    <div class="drawer-card">
      <div style="font-weight:900; margin-bottom:6px;">Description</div>
      <div class="drawer-muted" id="viewDesc">—</div>
    </div>

    <div class="drawer-card" id="viewFileCard" style="display:none;">
      <div style="font-weight:900; margin-bottom:10px;">Attachment</div>
      <div class="drawer-muted" id="viewFileName"></div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <a class="btn-mini" id="btnViewFile" target="_blank">View</a>
        <a class="btn-mini ghost" id="btnDownloadFile">Download</a>
      </div>
    </div>
  </div>
</aside>

<!-- =========================================
     EDIT TASK DRAWER
========================================= -->
<div class="drawer-backdrop" id="editBackdrop"></div>

<aside class="task-drawer" id="editDrawer" aria-hidden="true">
  <div class="drawer-head">
    <div>
      <div class="drawer-title">Edit Task</div>
      <div class="drawer-sub">Update and save changes</div>
    </div>
    <button type="button" class="drawer-x" id="closeEdit" aria-label="Close">×</button>
  </div>

  <form class="drawer-body" id="editForm" method="POST" enctype="multipart/form-data">
    <div class="drawer-field">
      <div class="drawer-label">TITLE</div>
      <input class="drawer-input" name="title" id="editTitle" required>
    </div>

    <div class="drawer-grid3">
      <div class="drawer-field">
        <div class="drawer-label">STATUS</div>
        <select class="drawer-input" name="status" id="editStatus">
          <option value="in_progress">In Progress</option>
          <option value="for_revision">For Revision</option>
          <option value="completed">Completed</option>
        </select>
      </div>

      <div class="drawer-field">
        <div class="drawer-label">PRIORITY</div>
        <select class="drawer-input" name="priority" id="editPriority">
          <option value="low">Low</option>
          <option value="normal">Normal</option>
          <option value="high">High</option>
        </select>
      </div>

      <div class="drawer-field">
        <div class="drawer-label">DUE DATE</div>
        <input type="date" class="drawer-input" name="due_date" id="editDate">
      </div>
    </div>

    <div class="drawer-field">
      <div class="drawer-label">DUE TIME</div>
      <input type="time" class="drawer-input" name="due_time" id="editTime">
    </div>

    <div class="drawer-field">
      <div class="drawer-label">DESCRIPTION</div>
      <textarea class="drawer-textarea" name="description" id="editDesc" rows="6"></textarea>
    </div>

    <div class="drawer-card">
      <div style="font-weight:900; margin-bottom:6px;">Replace Attachment (optional)</div>
      <input type="file" name="file" class="drawer-file">
    </div>

    <div class="drawer-footer">
      <button type="button" class="btn btn-light" id="cancelEdit">Cancel</button>
      <button type="submit" class="btn btn-primary">Save</button>
    </div>
  </form>
</aside>

<!-- =========================================
     OPEN/EDIT + FOCUS/HIGHLIGHT JS
     (scrolls INSIDE .scroll, header stays)
========================================= -->
<script>
(function(){
  const fab = document.getElementById("openTaskDrawer");

  const viewDrawer = document.getElementById("viewDrawer");
  const viewBackdrop = document.getElementById("viewBackdrop");
  const closeView = document.getElementById("closeView");

  const editDrawer = document.getElementById("editDrawer");
  const editBackdrop = document.getElementById("editBackdrop");
  const closeEdit = document.getElementById("closeEdit");
  const cancelEdit = document.getElementById("cancelEdit");

  const editForm = document.getElementById("editForm");
  const scrollContainer = document.querySelector(".scroll");

  const LAST_EDIT_KEY = "lastEditedTaskId";

  function hideFab(){ if(fab) fab.classList.add("fab-hidden"); }
  function showFab(){ if(fab) fab.classList.remove("fab-hidden"); }

  function openDrawer(el, back){
    el.classList.add("open");
    back.classList.add("open");
    el.setAttribute("aria-hidden","false");
    hideFab();
  }

  function closeDrawer(el, back){
    el.classList.remove("open");
    back.classList.remove("open");
    el.setAttribute("aria-hidden","true");

    const anyOpen =
      (viewDrawer && viewDrawer.classList.contains("open")) ||
      (editDrawer && editDrawer.classList.contains("open"));

    if(!anyOpen) showFab();
  }

  function setLastEdited(id){
    if(id !== null && id !== undefined && String(id).trim() !== ""){
      sessionStorage.setItem(LAST_EDIT_KEY, String(id));
    }
  }
  function getLastEdited(){ return sessionStorage.getItem(LAST_EDIT_KEY); }
  function clearLastEdited(){ sessionStorage.removeItem(LAST_EDIT_KEY); }

  if(closeView) closeView.onclick = () => closeDrawer(viewDrawer, viewBackdrop);
  if(viewBackdrop) viewBackdrop.onclick = () => closeDrawer(viewDrawer, viewBackdrop);

  if(closeEdit) closeEdit.onclick = () => { clearLastEdited(); closeDrawer(editDrawer, editBackdrop); };
  if(cancelEdit) cancelEdit.onclick = () => { clearLastEdited(); closeDrawer(editDrawer, editBackdrop); };
  if(editBackdrop) editBackdrop.onclick = () => { clearLastEdited(); closeDrawer(editDrawer, editBackdrop); };

  async function loadTask(taskId){
    const res = await fetch(`/task/${taskId}/json`);
    if(!res.ok) return null;
    return await res.json();
  }

  function highlightRow(taskId){
    const row = document.querySelector(`.task-item[data-task-id="${taskId}"]`);
    if(!row) return;

    document.querySelectorAll(".task-item.task-focus").forEach(x => x.classList.remove("task-focus"));
    row.classList.add("task-focus");

    // open all sections so row is visible
    document.querySelectorAll(".sec").forEach(sec => sec.classList.add("open"));

    // ✅ scroll INSIDE the list container (.scroll), not the whole page
    if(scrollContainer){
      const containerRect = scrollContainer.getBoundingClientRect();
      const rowRect = row.getBoundingClientRect();

      // bring row near upper-middle of the scroll container
      const offset = (rowRect.top - containerRect.top) - (scrollContainer.clientHeight / 3);

      scrollContainer.scrollBy({ top: offset, behavior: "smooth" });
    } else {
      // fallback
      row.scrollIntoView({ behavior:"smooth", block:"center" });
    }

    setTimeout(() => row.classList.remove("task-focus"), 2800);
  }

  async function openViewTask(taskId){
    const data = await loadTask(taskId);
    if(!data) return;

    document.getElementById("viewTitle").textContent = data.title || "Task";
    document.getElementById("viewStatus").textContent = (data.status || "-").replaceAll("_"," ").toUpperCase();
    document.getElementById("viewPriority").textContent = (data.priority || "-").toUpperCase();
    document.getElementById("viewDeadline").textContent = data.deadline || "-";
    document.getElementById("viewDesc").textContent = data.description || "—";

    const fileCard = document.getElementById("viewFileCard");
    if(data.file_path){
      fileCard.style.display = "block";
      document.getElementById("viewFileName").textContent = data.file_path;
      document.getElementById("btnViewFile").href = `/task/${taskId}/file/view`;
      document.getElementById("btnDownloadFile").href = `/task/${taskId}/file/download`;
    } else {
      fileCard.style.display = "none";
    }

    openDrawer(viewDrawer, viewBackdrop);
  }

  async function openEditTask(taskId){
    const data = await loadTask(taskId);
    if(!data) return;

    setLastEdited(taskId);

    editForm.action = `/task/${taskId}/update`;
    document.getElementById("editTitle").value = data.title || "";
    document.getElementById("editStatus").value = data.status || "in_progress";
    document.getElementById("editPriority").value = data.priority || "normal";
    document.getElementById("editDesc").value = data.description || "";

    if(data.deadline){
      const parts = data.deadline.split(" ");
      if(parts[0]) document.getElementById("editDate").value = parts[0];
      if(parts[1]) document.getElementById("editTime").value = parts[1];
    } else {
      document.getElementById("editDate").value = "";
      document.getElementById("editTime").value = "";
    }

    openDrawer(editDrawer, editBackdrop);
  }

  if(editForm){
    editForm.addEventListener("submit", () => {
      const action = editForm.getAttribute("action") || "";
      const m = action.match(/\/task\/(\d+)\/update/);
      if(m && m[1]) setLastEdited(m[1]);
    });
  }

  document.addEventListener("click", async (e) => {
    const openBtn = e.target.closest("[data-open-task]");
    const editBtn = e.target.closest("[data-edit-task]");
    const focusBtn = e.target.closest("[data-focus-task]");

    if(openBtn){
      const id = openBtn.getAttribute("data-open-task");
      highlightRow(id);
      await openViewTask(id);
      return;
    }

    if(editBtn){
      const id = editBtn.getAttribute("data-edit-task");
      highlightRow(id);
      await openEditTask(id);
      return;
    }

    if(focusBtn){
      if(focusBtn.tagName.toLowerCase() === "a") e.preventDefault();
      const id = focusBtn.getAttribute("data-focus-task");
      highlightRow(id);
      await openViewTask(id);
      return;
    }
  });

  document.addEventListener("DOMContentLoaded", async () => {
    const editedId = getLastEdited();
    if(editedId){
      highlightRow(editedId);
      clearLastEdited();
      return;
    }

    const params = new URLSearchParams(window.location.search);
    const openId = params.get("open");
    const focusId = params.get("focus");
    const highlight = params.get("highlight");

    const id = openId || focusId;
    if(!id) return;

    if(highlight === "1" || highlight === "true"){
      highlightRow(id);
    }

    if(openId){
      await openViewTask(openId);
    }
  });

  document.addEventListener("keydown", (e) => {
    if(e.key !== "Escape") return;

    if(viewDrawer && viewDrawer.classList.contains("open")){
      closeDrawer(viewDrawer, viewBackdrop);
    }
    if(editDrawer && editDrawer.classList.contains("open")){
      clearLastEdited();
      closeDrawer(editDrawer, editBackdrop);
    }
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const modals = document.querySelectorAll(".autoModal");
  if(!modals.length) return;

  modals.forEach((m) => {
    m.style.transition = "opacity 300ms ease";
  });

  setTimeout(() => {
    modals.forEach((m) => m.style.opacity = "0");
    setTimeout(() => {
      modals.forEach((m) => m.remove());
    }, 320);
  }, 1500);
});
</script>

{% endblock %}
