{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}

<style>
  /* ===============================
     LAYOUT: keep top controls fixed
     =============================== */
  .main-inner{
    display:flex;
    flex-direction:column;
    height:100vh;
    overflow:hidden; /* prevents whole page scroll */
  }

  /* Keep header elements fixed */
  .td-title,
  .td-sub{
    position: sticky;
    top: 0;
    z-index: 30;
    background: #f4f6f9; /* match your page background */
  }

  /* Toast should stay on top too */
  .toast-wrap{
    position: sticky;
    top: 70px; /* below the title/sub; adjust if needed */
    z-index: 40;
  }

  /* Only planner area scrolls */
  .planner-wrap{
    flex:1;
    overflow-y:auto;
    padding-right:8px;
  }

  .task-status-pill{
    display:inline-block;
    padding:4px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:800;
    text-transform:uppercase;
    letter-spacing:.3px;
    border:1px solid transparent;
  }
  .task-status-pill.status-pending{ background:#fef3c7; border-color:#f7c900; color:#92400e; }
  .task-status-pill.status-delayed{ background:#fef2f2; border-color:#fa0000; color:#b91c1c; }
  .task-status-pill.status-completed{ background:#ecfdf5; border-color:#00ff59; color:#065f46; }
</style>

<div class="main-inner">

  <div class="td-title">Dashboard</div>
  <div class="td-sub">Overview of meetings and tasks</div>

  {# Flash popup ONLY here #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        {% if message == "Task updated!" %}
          <div class="modal-overlay show autoModal">
            <div class="modal-popup {{ category }} modern-popup" role="status" aria-live="polite">
              <div class="modal-icon-wrap">
                <div class="modal-icon" aria-hidden="true">
                  {% if category == "error" %}‚úï{% else %}‚úì{% endif %}
                </div>
              </div>
              <div class="modal-text">{{ message }}</div>
              <div class="modal-subtext">
                {% if category == "error" %}
                  Please review your changes and try again.
                {% else %}
                  Your latest task changes were saved successfully.
                {% endif %}
              </div>
              <div class="modal-progress" aria-hidden="true"></div>
            </div>
          </div>
        {% else %}
          <div class="toast-wrap" id="toastWrap">
            <div class="toast-msg {% if category == 'error' %}toast-error{% else %}toast-success{% endif %}">
              {{ message }}
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="planner-wrap" id="plannerWrap">

    {% if planned_days and planned_days|length > 0 %}
      {% for day in planned_days %}
        <div class="day-block">

          <div class="day-head">
            <div>
              <span class="day-title">{{ day.date_label }}</span>
              {% if day.date_sub %}
                <span class="day-sub">{{ day.date_sub }}</span>
              {% endif %}
            </div>
          </div>

          <div class="day-line"></div>

          {% set has_tasks = day.tasks and day.tasks|length > 0 %}
          {% set has_meetings = day.meetings and day.meetings|length > 0 %}

          {% if not has_tasks and not has_meetings %}
            <div class="nothing">Nothing Planned Yet</div>
          {% else %}

            <!-- ================= LIST VIEW (default) ================= -->
            <div class="list-view">
              {% if has_tasks %}
                {% for t in day.tasks %}
                  <div class="plan-row"
                       data-item-type="task"
                       data-task-id="{{ t.id }}"
                       data-status="{{ t.status }}"
                       data-original-status="{{ t.status if t.status != 'completed' else 'in_progress' }}"
                       data-is-delayed="{{ '1' if t.is_delayed else '0' }}">
                    <button type="button"
                            class="plan-check {% if t.status == 'completed' %}is-done{% endif %}"
                            aria-label="Mark complete"
                            data-complete-task="{{ t.id }}"
                            data-original-status="{{ t.status if t.status != 'completed' else 'in_progress' }}">‚úì</button>

                    <div class="plan-mid">
                      <div class="plan-title">
                        {# ‚úÖ Title click -> redirect to Task Dashboard #}
                        <a class="task-link"
                           data-jump-task="{{ t.id }}"
                           href="{{ url_for('views.task_dashboard') }}?open={{ t.id }}&highlight=1">
                          {{ t.title }}
                        </a>
                      </div>

                      <div class="plan-sub">
                        {{ (t.status|replace("_"," ")|title) }}
                        {% if t.due_time %} ‚Ä¢ Due {{ t.due_time }}{% endif %}
                      </div>
                    </div>

                    <div class="plan-right">
                      {% set status_label = 'COMPLETED' if t.status == 'completed' else ('DELAYED' if t.is_delayed else (t.status|replace("_"," ")|upper)) %}
                      {% set status_class = 'status-completed' if t.status == 'completed' else ('status-delayed' if t.is_delayed else 'status-pending') %}
                      <span class="task-status-pill {{ status_class }}" data-status-pill>{{ status_label }}</span>
                      <span class="pill task">Task</span>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}

              {% if has_meetings %}
                {% for m in day.meetings %}
                  <div class="plan-row" data-item-type="meeting">
                    <button type="button" class="plan-check is-disabled" disabled>‚úì</button>

                    <div class="plan-mid">
                      <div class="plan-title">{{ m.title }}</div>
                      <div class="plan-sub">
                        {% if m.time_range %}{{ m.time_range }}{% endif %}
                        {% if m.room %} ‚Ä¢ {{ m.room }}{% endif %}
                      </div>
                    </div>

                    <div class="plan-right">
                      <span class="pill meeting">Meeting</span>
                    </div>
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <!-- ================= CARD VIEW (Classroom style) ================= -->
            <div class="card-view-wrap">
              <div class="card-grid">

                {% if has_tasks %}
                  {% for t in day.tasks %}
                    {% set cover = "cover-teal" %}
                    {% if t.status == "completed" %}{% set cover = "cover-green" %}{% endif %}
                    {% if t.status == "for_revision" %}{% set cover = "cover-purple" %}{% endif %}

                    <div class="gcard"
                         data-item-type="task"
                         data-task-id="{{ t.id }}"
                         data-status="{{ t.status }}"
                         data-original-status="{{ t.status if t.status != 'completed' else 'in_progress' }}"
                         data-is-delayed="{{ '1' if t.is_delayed else '0' }}">
                      <div class="gcard-cover {{ cover }}">
                        <div class="gcard-menu">‚ãÆ</div>
                      </div>

                      <div class="gcard-body">
                        <div class="gcard-topline">{{ t.title }}</div>
                        <div class="gcard-subline" data-status-text>{{ (t.status|replace("_"," ")|title) }}</div>
                        <div class="gcard-small">
                          {% if t.due_time %}Due {{ t.due_time }}{% else %}No due time{% endif %}
                        </div>
                      </div>

                      <div class="gcard-footer">
                        <div class="gicons">
                          {# ‚úÖ Details icon -> redirect to Task Dashboard #}
                          <a class="gicon"
                             title="Details"
                             data-jump-task="{{ t.id }}"
                             href="{{ url_for('views.task_dashboard') }}?open={{ t.id }}&highlight=1">
                            üìù
                          </a>
                        </div>

                        <div style="display:flex; align-items:center; gap:10px;">
                          <button type="button"
                                  class="gcheck {% if t.status == 'completed' %}is-done{% endif %}"
                                  aria-label="Mark complete"
                                  data-complete-task="{{ t.id }}"
                            data-original-status="{{ t.status if t.status != 'completed' else 'in_progress' }}">‚úì</button>

                          {% set status_label = 'COMPLETED' if t.status == 'completed' else ('DELAYED' if t.is_delayed else (t.status|replace("_"," ")|upper)) %}
                          {% set status_class = 'status-completed' if t.status == 'completed' else ('status-delayed' if t.is_delayed else 'status-pending') %}
                          <span class="task-status-pill {{ status_class }}" data-status-pill>{{ status_label }}</span>
                          <span class="gcard-pill">Task</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}

                {% if has_meetings %}
                  {% for m in day.meetings %}
                    <div class="gcard" data-item-type="meeting">
                      <div class="gcard-cover cover-slate">
                        <div class="gcard-menu">‚ãÆ</div>
                      </div>

                      <div class="gcard-body">
                        <div class="gcard-topline">{{ m.title }}</div>
                        <div class="gcard-subline">Meeting</div>
                        <div class="gcard-small">
                          {% if m.time_range %}{{ m.time_range }}{% endif %}
                          {% if m.room %} ‚Ä¢ {{ m.room }}{% endif %}
                        </div>
                      </div>

                      <div class="gcard-footer">
                        <div class="gicons">
                          <span class="gicon" title="Details">üìù</span>
                        </div>

                        <div style="display:flex; align-items:center; gap:10px;">
                          <button type="button" class="gcheck is-disabled" disabled>‚úì</button>
                          <span class="gcard-pill">Meeting</span>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}

              </div>
            </div>

          {% endif %}
        </div>
      {% endfor %}

    {% else %}
      <div class="day-block">
        <div class="day-head">
          <div><span class="day-title">Today</span></div>
        </div>
        <div class="day-line"></div>
        <div class="nothing">Nothing Planned Yet</div>
      </div>
    {% endif %}

  </div>

</div>

{# ‚úÖ Floating button group (toggle) #}
<div class="fab-group">
  <div class="view-toggle">
    <button type="button" class="view-mini" id="btnList">List View</button>
    <button type="button" class="view-mini" id="btnCards">Card View</button>
  </div>
</div>

<script>
/* ===== toast auto-hide ===== */
window.addEventListener("DOMContentLoaded", () => {
  const wrap = document.getElementById("toastWrap");
  if(wrap){
    const toasts = wrap.querySelectorAll(".toast-msg");
    if(toasts.length){
      requestAnimationFrame(() => toasts.forEach(t => t.classList.add("show")));
      setTimeout(() => {
        toasts.forEach(t => t.classList.remove("show"));
        setTimeout(() => wrap.remove(), 220);
      }, 1500);
    }
  }

  const modals = document.querySelectorAll(".autoModal");
  if(!modals.length) return;


  const toasts = wrap.querySelectorAll(".toast-msg");
  modals.forEach((m) => {
    m.style.transition = "opacity 300ms ease";
  });

  setTimeout(() => {
    modals.forEach((m) => m.style.opacity = "0");
    setTimeout(() => {
      modals.forEach((m) => m.remove());
    }, 320);
  }, 1500);
});

/* ===== list/card toggle remember ===== */
(function(){
  const wrap = document.getElementById("plannerWrap");
  const btnList = document.getElementById("btnList");
  const btnCards = document.getElementById("btnCards");

  if(!wrap || !btnList || !btnCards) return;

  function setView(mode){
    const isCards = (mode === "cards");
    wrap.classList.toggle("card-view", isCards);
    btnList.classList.toggle("active", !isCards);
    btnCards.classList.toggle("active", isCards);
    localStorage.setItem("dashboard_view_mode", mode);
  }

  const saved = localStorage.getItem("dashboard_view_mode") || "list";
  setView(saved);

  btnList.addEventListener("click", () => setView("list"));
  btnCards.addEventListener("click", () => setView("cards"));
})();

/* ===== checkmark click to complete task (both views) ===== */
function toTitle(value){
  return (value || "").replaceAll("_", " ").replace(/\b\w/g, (m) => m.toUpperCase());
}

function statusClass(status, isDelayed){
  if(status === "completed") return "status-completed";
  return isDelayed ? "status-delayed" : "status-pending";
}

function statusLabel(status, isDelayed){
  if(status === "completed") return "COMPLETED";
  return isDelayed ? "DELAYED" : (status || "in_progress").replaceAll("_", " ").toUpperCase();
}

document.addEventListener("click", async (e) => {
  const btn = e.target.closest("[data-complete-task]");
  if(!btn) return;

  const id = btn.getAttribute("data-complete-task");
  if(!id) return;

  const stateNode = document.querySelector(`[data-task-id="${id}"][data-item-type="task"]`);
  const currentStatus = stateNode?.dataset.status || "in_progress";
  const originalStatus = stateNode?.dataset.originalStatus || btn.dataset.originalStatus || (currentStatus === "completed" ? "in_progress" : currentStatus);
  const targetStatus = currentStatus === "completed" ? originalStatus : "completed";

  try{
    const body = new URLSearchParams({
      target_status: targetStatus,
      fallback_status: originalStatus,
    });

    const res = await fetch(`/task/${id}/complete`, {
      method: "POST",
      headers: {
        "X-Requested-With": "fetch",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body,
    });

    const data = await res.json();
    if(!res.ok || !data.ok) return;

    const done = (data.status === "completed");

    document.querySelectorAll(`[data-complete-task="${id}"]`).forEach((b) => {
      b.classList.toggle("is-done", done);
    });

    document.querySelectorAll(`[data-task-id="${id}"][data-item-type="task"]`).forEach((taskEl) => {
      const dueFlag = taskEl.dataset.isDelayed === "1";
      taskEl.dataset.status = data.status;

      taskEl.querySelectorAll("[data-status-pill]").forEach((pill) => {
        pill.textContent = statusLabel(data.status, dueFlag && data.status !== "completed");
        pill.classList.remove("status-pending", "status-delayed", "status-completed");
        pill.classList.add(statusClass(data.status, dueFlag && data.status !== "completed"));
      });

      taskEl.querySelectorAll(".plan-sub, [data-status-text]").forEach((sub) => {
        const raw = sub.textContent || "";
        const parts = raw.split("‚Ä¢");
        const right = parts.length > 1 ? " ‚Ä¢ " + parts.slice(1).join("‚Ä¢").trim() : "";
        sub.textContent = toTitle(data.status) + (sub.classList.contains("plan-sub") ? right : "");
      });
    });

  }catch(err){
    console.error(err);
  }
});
</script>

{% endblock %}
